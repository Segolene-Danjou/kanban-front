!function(){var e="http://localhost:3000";const t={makeTagDOMObject:(e,a,o,r)=>{let d=document.createElement("div");return d.classList.add("tag"),d.style.backgroundColor=a,d.textContent=e,d.setAttribute("tag-id",o),d.setAttribute("card-id",r),d.addEventListener("dblclick",t.disassociateTag),d},addTagToDOM:(e,t)=>{document.querySelector(`[card-id="${t}"] .tags`).appendChild(e)},showAssociateModal:async a=>{const o=a.target.closest(".box").getAttribute("card-id"),r=document.getElementById("associateTagModal");try{let a=await fetch(e+"/tags");if(!a.ok)throw await a.json();{let e=await a.json(),d=document.createElement("section");d.classList.add("modal-card-body");for(let a of e){let e=t.makeTagDOMObject(a.name,a.color,a.id,o);e.addEventListener("click",t.handleAssociateTag),d.appendChild(e)}r.querySelector(".modal-card-body").replaceWith(d),r.classList.add("is-active")}}catch(d){alert("Impossible de r\xe9cup\xe9rer les tags"),console.error(d)}},handleAssociateTag:async a=>{const o=a.target.getAttribute("tag-id"),r=a.target.getAttribute("card-id");try{let a=new FormData;a.set("tag_id",o);let d=await fetch(e+`/cards/${r}/tags`,{method:"POST",body:a});if(!d.ok)throw await d.json();{let e=await d.json(),a=document.querySelectorAll(`[card-id="${e.id}"] .tag`);for(let t of a)t.remove();let o=document.querySelector(`[card-id="${e.id}"] .tags`);for(let r of e.tags){let a=t.makeTagDOMObject(r.name,r.color,r.id,e.id);o.appendChild(a)}}}catch(d){alert("Impossible d'associer le tag"),console.error(d)}document.getElementById("associateTagModal").classList.remove("is-active")},disassociateTag:async t=>{const a=t.target.getAttribute("tag-id"),o=t.target.getAttribute("card-id");try{let r=await fetch(e+`/cards/${o}/tags/${a}`,{method:"DELETE"});if(!r.ok)throw await r.json();t.target.remove()}catch(r){alert("Impossible de d\xe9sassocier le tag"),console.error(r)}},makeEditTagForm:e=>{let a=document.getElementById("newTagForm"),o=document.importNode(a,!0);o.setAttribute("id",null),o.classList.add("editTagForm"),o.querySelector('[name="name"]').value=e.name,o.querySelector('[name="color"]').value=e.color,console.log(e.color,o.querySelector('[name="color"]').value),o.setAttribute("tag-id",e.id),o.addEventListener("submit",t.handleEditTag);let r=document.createElement("div");return r.classList.add("button","is-small","is-danger"),r.textContent="Supprimer",r.addEventListener("click",t.handleDeleteTag),o.querySelector(".field").appendChild(r),o},showEditModal:async()=>{try{let a=await fetch(e+"/tags");const o=document.getElementById("addAndEditTagModal");let r=await a.json(),d=document.createElement("div");d.classList.add("editTagForms");for(let e of r){let a=t.makeEditTagForm(e);d.appendChild(a)}o.querySelector(".editTagForms").replaceWith(d),o.classList.add("is-active")}catch(a){alert("Impossible de r\xe9cup\xe9rer les tags"),console.error(a)}},handleNewTag:async t=>{t.preventDefault();let a=new FormData(t.target);try{let t=await fetch(e+"/tags",{method:"POST",body:a});if(!t.ok)throw await t.json()}catch(o){alert("Impossible de cr\xe9er le tag"),console.error(o)}document.getElementById("addAndEditTagModal").classList.remove("is-active")},handleEditTag:async t=>{t.preventDefault();let a=new FormData(t.target),o=t.target.getAttribute("tag-id");try{let t=await fetch(e+"/tags/"+o,{method:"PATCH",body:a});if(!t.ok)throw await t.json();{let e=await t.json(),a=document.querySelectorAll(`[tag-id="${e.id}"]`);for(let t of a)t.textContent=e.name,t.style.backgroundColor=e.color}}catch(r){alert("Impossible de mettre le tag \xe0 jour"),console.error(r)}document.getElementById("addAndEditTagModal").classList.remove("is-active")},handleDeleteTag:async t=>{const a=t.target.closest("form").getAttribute("tag-id");try{let t=await fetch(e+"/tags/"+a,{method:"DELETE"});if(!t.ok)throw await t.json();{let e=document.querySelectorAll(`[tag-id="${a}"]`);for(let t of e)t.remove()}}catch(o){alert("Impossible de supprimer le tag"),console.error(o)}document.getElementById("addAndEditTagModal").classList.remove("is-active")}};var a=t;const o={showAddModal:e=>{const t=e.target.closest(".panel").getAttribute("list-id");let a=document.getElementById("addCardModal");a.querySelector('input[name="list_id"]').value=t,a.classList.add("is-active")},handleAddFormSubmit:async t=>{let a=new FormData(t.target);try{let t=await fetch(e+"/cards",{method:"POST",body:a});if(!t.ok)throw await t.json();{let e=await t.json(),a=o.makeCardDOMObject(e.content,e.id,e.color);o.addCardToDOM(a,e.list_id)}}catch(r){alert("Impossible de cr\xe9er une carte"),console.error(r)}},showEditForm:e=>{let t=e.target.closest(".box"),a=t.querySelector("form"),r=t.querySelector(".card-name");a.querySelector('input[name="content"]').value=r.textContent,a.querySelector('input[name="color"]').value=o.rgb2hex(t.style.backgroundColor),r.classList.add("is-hidden"),a.classList.remove("is-hidden")},handleEditCardForm:async t=>{t.preventDefault();let a=new FormData(t.target),o=t.target.closest(".box");const r=o.getAttribute("card-id");try{let t=await fetch(e+"/cards/"+r,{method:"PATCH",body:a});if(200!==t.status)throw await t.json();{let e=await t.json();o.querySelector(".card-name").textContent=e.content,o.style.backgroundColor=e.color}}catch(d){alert("Impossible de modifier la carte"),console.error(d)}t.target.classList.add("is-hidden"),o.querySelector(".card-name").classList.remove("is-hidden")},makeCardDOMObject:(e,t,r)=>{let d=document.getElementById("template-card"),l=document.importNode(d.content,!0);l.querySelector(".card-name").textContent=e;let s=l.querySelector(".box");return s.setAttribute("card-id",t),s.setAttribute("style","background-color: "+r),l.querySelector(".button--edit-card").addEventListener("click",o.showEditForm),l.querySelector("form").addEventListener("submit",o.handleEditCardForm),l.querySelector(".button--delete-card").addEventListener("click",o.deleteCard),l.querySelector(".button--add-tag").addEventListener("click",a.showAssociateModal),l},addCardToDOM:(e,t)=>{document.querySelector(`[list-id="${t}"]`).querySelector(".panel-block").appendChild(e)},deleteCard:async t=>{if(!confirm("Supprimer cette carte ?"))return;let a=t.target.closest(".box");const o=a.getAttribute("card-id");try{let t=await fetch(e+"/cards/"+o,{method:"DELETE"});if(!t.ok)throw await t.json();a.remove()}catch(r){alert("Impossible de supprimer la carte"),console.error(r)}},rgb2hex:e=>{if("#"===e.charAt(0))return e;let t=e.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+))?\)$/);function a(e){return("0"+parseInt(e).toString(16)).slice(-2)}return"#"+a(t[1])+a(t[2])+a(t[3])}};var r=o;const d={showAddModal:()=>{document.getElementById("addListModal").classList.add("is-active")},handleAddFormSubmit:async t=>{let a=new FormData(t.target),o=document.querySelectorAll(".panel").length;a.set("page_order",o);try{let t=await fetch(e+"/lists",{method:"POST",body:a});if(!t.ok)throw await t.json();{const e=await t.json();let a=d.makeListDOMObject(e.name,e.id);d.addListToDOM(a)}}catch(r){alert("Impossible de cr\xe9er une liste"),console.error(r)}},showEditForm:e=>{let t=e.target.closest(".panel").querySelector("form");t.querySelector('input[name="name"]').value=e.target.textContent,e.target.classList.add("is-hidden"),t.classList.remove("is-hidden")},handleEditListForm:async t=>{t.preventDefault();let a=new FormData(t.target),o=t.target.closest(".panel");const r=o.getAttribute("list-id");try{let t=await fetch(e+"/lists/"+r,{method:"PATCH",body:a});if(200!==t.status)throw await t.json();{let e=await t.json();o.querySelector("h2").textContent=e.name}}catch(d){alert("Impossible de modifier la liste"),console.error(d)}t.target.classList.add("is-hidden"),o.querySelector("h2").classList.remove("is-hidden")},makeListDOMObject:(e,t)=>{let a=document.getElementById("template-list"),o=document.importNode(a.content,!0);o.querySelector("h2").textContent=e,o.querySelector(".panel").setAttribute("list-id",t),o.querySelector(".button--add-card").addEventListener("click",r.showAddModal),o.querySelector("h2").addEventListener("dblclick",d.showEditForm),o.querySelector("form").addEventListener("submit",d.handleEditListForm),o.querySelector(".button--delete-list").addEventListener("click",d.deleteList);let l=o.querySelector(".panel-block");return new Sortable(l,{group:"list",draggable:".box",onEnd:d.handleDropCard}),o},addListToDOM:e=>{document.getElementById("addListButton").closest(".column").before(e),document.querySelector(".card-lists").scrollTo(document.querySelector(".card-lists").offsetWidth,0)},deleteList:async t=>{let a=t.target.closest(".panel");const o=a.getAttribute("list-id");if(a.querySelectorAll(".box").length)alert("Impossible de supprimer une liste non vide");else if(confirm("Supprimer cette liste ?"))try{let t=await fetch(e+"/lists/"+o,{method:"DELETE"});if(!t.ok)throw await t.json();a.remove()}catch(r){alert("Impossible de supprimer la liste."),console.log(r)}},updateAllLists:()=>{document.querySelectorAll(".panel").forEach((t,a)=>{const o=t.getAttribute("list-id");let r=new FormData;r.set("position",a),fetch(e+"/lists/"+o,{method:"PATCH",body:r})})},updateAllCards:(t,a)=>{t.forEach((t,o)=>{const r=t.getAttribute("card-id");let d=new FormData;d.set("position",o),d.set("list_id",a),fetch(e+"/cards/"+r,{method:"PATCH",body:d})})},handleDropCard:e=>{e.item;let t=e.from,a=e.to,o=t.querySelectorAll(".box"),r=t.closest(".panel").getAttribute("list-id");d.updateAllCards(o,r),t!==a&&(o=a.querySelectorAll(".box"),r=a.closest(".panel").getAttribute("list-id"),d.updateAllCards(o,r))},handleDropList:e=>{d.updateAllLists()}};var l=d,s={init:function(){s.addListenerToActions(),s.getListsFromAPI()},addListenerToActions:()=>{document.getElementById("addListButton").addEventListener("click",l.showAddModal);let e=document.querySelectorAll(".close");for(let t of e)t.addEventListener("click",s.hideModals);document.querySelector("#addListModal form").addEventListener("submit",s.handleAddListForm),document.querySelector("#addCardModal form").addEventListener("submit",s.handleAddCardForm),document.getElementById("editTagsButton").addEventListener("click",a.showEditModal),document.getElementById("newTagForm").addEventListener("submit",a.handleNewTag)},hideModals:()=>{let e=document.querySelectorAll(".modal");for(let t of e)t.classList.remove("is-active")},handleAddListForm:async e=>{e.preventDefault(),await l.handleAddFormSubmit(e),s.hideModals()},handleAddCardForm:async e=>{e.preventDefault(),await r.handleAddFormSubmit(e),s.hideModals()},getListsFromAPI:async()=>{try{let t=await fetch(e+"/lists");if(200!==t.status)throw await t.json();{let e=await t.json();for(let t of e){let e=l.makeListDOMObject(t.name,t.id);l.addListToDOM(e);for(let o of t.cards){let e=r.makeCardDOMObject(o.content,o.id,o.color);r.addCardToDOM(e,t.id);for(let t of o.tags){let e=a.makeTagDOMObject(t.name,t.color,t.id,o.id);a.addTagToDOM(e,o.id)}}}}let o=document.querySelector(".card-lists");new Sortable(o,{group:"project",draggable:".panel",onEnd:l.handleDropList})}catch(t){alert("Impossible de charger les listes depuis l'API."),console.error(t)}}};document.addEventListener("DOMContentLoaded",s.init)}();